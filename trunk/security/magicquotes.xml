<?xml version="1.0" encoding="gb2312"?>
<!-- $Revision: 1.2 $ -->
<!-- $Author: lm92 $ -->
<!-- EN-Revision: 1.7 Maintainer: lm92 Status: ready -->
  <chapter id="security.magicquotes">
   <title>Magic Quotes</title>

   <para>
    Magic Quotes 就是把输入 PHP 敏感字符自动进行转义的一个操作选项。它会根据需要对没有被
    magic quotes处理的敏感字符进行转义。
   </para>

   <sect1 id="security.magicquotes.what">
    <title>什么是 Magic Quotes</title>
    <para>
     当Magic Quotes打开的时候，所有的 <literal>'</literal> （单引号），<literal>"</literal>
     （双引号），<literal>\</literal> （反斜杠）和 <literal>NULL</literal>
     字符都会被添加反斜杠进行转义。这样产生效果就相当于使用
     <function>addslashes</function> 函数。
    </para>
    <para>
     一共有三个 magic quote 选项：
    </para>
    <itemizedlist>
     <listitem>
      <simpara>
       <link linkend="ini.magic-quotes-gpc">magic_quotes_gpc</link>
      </simpara>
      <simpara>
       作用于 HTTP 请求所发送的数据(GET, POST, and COOKIE)，运行时不能被改变，在
       PHP 中默认值为 <emphasis>on</emphasis>
      </simpara>
      <simpara>
       参见 <function>get_magic_quotes_gpc</function>.
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       <link linkend="ini.magic-quotes-runtime">magic_quotes_runtime</link>
      </simpara>
      <simpara>
       如果打开的话，大部份内部函数，包括数据库和文本文件，所返回的数据都会被反斜杠进行转义。该选项能在运行的时候被改变，在
       PHP 中的默认值为 <emphasis>off</emphasis>
      </simpara>
      <simpara>
       参见 <function>set_magic_quotes_runtime</function> 和
       <function>get_magic_quotes_runtime</function>.
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       <link linkend="ini.magic-quotes-sybase">magic_quotes_sybase</link>
      </simpara>
      <simpara>
       如果打开的话，将会使用单引号对单引号进行转义而非反斜框。这时
       <link linkend="ini.magic-quotes-gpc">magic_quotes_gpc</link>
       将会被忽略。换而言之，如果同时打开两个选项的话，单引号将会被转义成
       <literal>''</literal>。 而双引号、反斜杠、 NULL 字符将不会进行转义。
      </simpara>
      <simpara>
       参见 <function>ini_get</function> 是如何得到这个选项的值的。
      </simpara>
     </listitem>
    </itemizedlist>
   </sect1>

   <sect1 id="security.magicquotes.why">
    <title>为什么要用 Magic Quotes</title>
    <itemizedlist>
     <listitem>
      <simpara>
       对初级用户很有帮助
      </simpara>
      <simpara>
       Magic quotes 是一个能够帮助初级用户提高安全性的工具。尽管
       <link linkend="security.database.sql-injection">SQL 注入</link> 
       在 magic quotes 打开的情况下仍然有可能实现，但起码系统的风险减少很多了。
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       方便
      </simpara>
      <simpara>
       当向数据库中插入数据时，magic quotes所做的就是自动对所有的
       GET、POST、COOKIE 数据运用 <function>addslashes</function> 函数。
      </simpara>
     </listitem>
    </itemizedlist>
   </sect1>

   <sect1 id="security.magicquotes.whynot">
    <title>为什么不要用 Magic Quotes</title>
    <itemizedlist>
     <listitem>
      <simpara>
       影响兼容性
      </simpara>
      <simpara>
       Magic Quotes 打开或并闭都会对兼容性产生一定的影响。可用
       <function>get_magic_quotes_gpc</function> 来检查它有没有打开，然后使用不同的应对措施。
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       影响执行效率
      </simpara>
      <simpara>
       由于并不是每一段被转义的数据都要插入数据库的，如果所有进入
       PHP 的数据都被转义的话，那么会对程序的执行效率产生一定的影响。这样还不如使用函数来有针对性的完成这个工作，如
       <function>addslashes</function> 。
      </simpara>
      <simpara>
       尽管 <filename>php.ini-dist</filename> 默认打开了这个选项，但是
       <filename>php.ini-recommended</filename> 默认却关闭了它，因为这套设置更着重于执行效率
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       在某些时候会带来不便
      </simpara>
      <simpara>
       要知道，并不是所有的数据都需要进行转义的，当把不需转义的数据转义以后，就会带来一些麻烦。比如说，如果对通过表单发送邮件转义的话，收件人就会见到一大堆的 \'。针对这个问题，可以使用
       <function>stripslashes</function> 函数处理。
      </simpara>
     </listitem>
    </itemizedlist>
   </sect1>

   <sect1 id="security.magicquotes.disabling">
    <title>关闭 Magic Quotes</title>
    <para>
     <link linkend="ini.magic-quotes-gpc">magic_quotes_gpc</link>
     选项只能在系统级的权限下关闭，不能在运行时关闭。也就是说
     <function>ini_set</function> 不能起作用。
    </para>
    <para>
     <example>
      <title>在服务器端关闭 magic quotes</title>
      <para>
       下面是一个通过 &php.ini; 文件把这些选项设为 <literal>Off</literal>
       的范例。更多信息请参见本手册的
       <link linkend="configuration.changes">如何改变选项设置</link>。
      </para>
      <screen>
<![CDATA[
; Magic quotes
;

; Magic quotes for incoming GET/POST/Cookie data.
magic_quotes_gpc = Off

; Magic quotes for runtime-generated data, e.g. data from SQL, from exec(), etc.
magic_quotes_runtime = Off

; Use Sybase-style magic quotes (escape ' with '' instead of \').
magic_quotes_sybase = Off
]]>
      </screen>
      <para>
       如果不能修改服务器端的配置文件，使用
       <filename>.htaccess</filename> 也可以。范例如下：
      </para>
      <screen>
<![CDATA[
php_flag magic_quotes_gpc Off
]]>
      </screen>
     </example>
    </para>
    <para>
     为了能写出兼容性较强的代码（可以运行在不同的环境），或者要应付不能修改服务器配置的情况，可以像下面这个例子那样做，它能关闭
     <link linkend="ini.magic-quotes-gpc">magic_quotes_gpc</link>
     设置。但是这样做比较低效，适当的修改配置才是更好的办法。
    </para>
    <para>
     <example>
      <title>在运行时关闭 magic quotes</title>
      <programlisting role="php">
<![CDATA[
<?php
if (get_magic_quotes_gpc()) {
    function stripslashes_deep($value)
    {
        $value = is_array($value) ?
                    array_map('stripslashes_deep', $value) :
                    stripslashes($value);

        return $value;
    }

    $_POST = array_map('stripslashes_deep', $_POST);
    $_GET = array_map('stripslashes_deep', $_GET);
    $_COOKIE = array_map('stripslashes_deep', $_COOKIE);
}
?>
]]>
      </programlisting>
     </example>
    </para>
   </sect1>

  </chapter>

<!-- Keep this comment at the end of the file
Local variables:
mode: sgml
sgml-omittag:t
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
indent-tabs-mode:nil
sgml-parent-document:nil
sgml-default-dtd-file:"../../manual.ced"
sgml-exposed-tags:nil
sgml-local-catalogs:nil
sgml-local-ecat-files:nil
End:
vim600: syn=xml fen fdm=syntax fdl=2 si
vim: et tw=78 syn=sgml
vi: ts=1 sw=1
-->
